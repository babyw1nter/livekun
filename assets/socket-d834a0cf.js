import{ao as a,ap as y}from"./index-2c669624.js";const N=t=>{try{return JSON.parse(new TextDecoder().decode(t))}catch{return{type:"UNKNOWN",data:{}}}},p=t=>new TextEncoder().encode(JSON.stringify(t)),w=async(t,d,n,s)=>{var i;const c=((i=a.currentRoute.value.query.uuid)==null?void 0:i.toString())||"";if(!c)return console.warn("没有 UUID 参数，不连接 socket 服务器！"),Promise.resolve(null);console.log("正在创建 WS 连接...");const e=new WebSocket(y,"web");e.binaryType="arraybuffer";const f=r=>{e.send(p(r))};return e.addEventListener("open",()=>{console.log("连接成功！"),f({type:"PLUGIN_CONNECT",data:{pluginName:t,uuid:c}})}),e.addEventListener("error",()=>{console.error("连接错误！")}),e.addEventListener("close",r=>{if(console.warn("连接关闭",r.code,r.reason),r.code===1002){console.error("远程服务器拒绝连接，不再尝试重新创建连接，请手动刷新页面！");return}console.warn("将于 5 秒后尝试重新创建连接..."),e.readyState!==WebSocket.CONNECTING&&e.readyState!==WebSocket.OPEN&&window.setTimeout(()=>w(t,d,n,s),5e3)}),e.addEventListener("message",r=>{const o=N(r.data);console.info("接收消息",o),typeof s<"u"&&s(r,e,o),typeof d<"u"&&(o==null?void 0:o.type)==="PLUGIN_ACTION"&&d(o.data.action),typeof n<"u"&&(o==null?void 0:o.type)==="PLUGIN_MESSAGE"&&n(o.data)}),Promise.resolve(e)};export{w as u};
