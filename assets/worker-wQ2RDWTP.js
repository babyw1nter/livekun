(function(){"use strict";function k(f){return f&&f.__esModule&&Object.prototype.hasOwnProperty.call(f,"default")?f.default:f}var g={exports:{}};(function(f){var p=Object.prototype.hasOwnProperty,o="~";function a(){}Object.create&&(a.prototype=Object.create(null),new a().__proto__||(o=!1));function _(s,t,n){this.fn=s,this.context=t,this.once=n||!1}function x(s,t,n,r,v){if(typeof n!="function")throw new TypeError("The listener must be a function");var l=new _(n,r||s,v),c=o?o+t:t;return s._events[c]?s._events[c].fn?s._events[c]=[s._events[c],l]:s._events[c].push(l):(s._events[c]=l,s._eventsCount++),s}function b(s,t){--s._eventsCount===0?s._events=new a:delete s._events[t]}function u(){this._events=new a,this._eventsCount=0}u.prototype.eventNames=function(){var t=[],n,r;if(this._eventsCount===0)return t;for(r in n=this._events)p.call(n,r)&&t.push(o?r.slice(1):r);return Object.getOwnPropertySymbols?t.concat(Object.getOwnPropertySymbols(n)):t},u.prototype.listeners=function(t){var n=o?o+t:t,r=this._events[n];if(!r)return[];if(r.fn)return[r.fn];for(var v=0,l=r.length,c=new Array(l);v<l;v++)c[v]=r[v].fn;return c},u.prototype.listenerCount=function(t){var n=o?o+t:t,r=this._events[n];return r?r.fn?1:r.length:0},u.prototype.emit=function(t,n,r,v,l,c){var d=o?o+t:t;if(!this._events[d])return!1;var e=this._events[d],h=arguments.length,y,i;if(e.fn){switch(e.once&&this.removeListener(t,e.fn,void 0,!0),h){case 1:return e.fn.call(e.context),!0;case 2:return e.fn.call(e.context,n),!0;case 3:return e.fn.call(e.context,n,r),!0;case 4:return e.fn.call(e.context,n,r,v),!0;case 5:return e.fn.call(e.context,n,r,v,l),!0;case 6:return e.fn.call(e.context,n,r,v,l,c),!0}for(i=1,y=new Array(h-1);i<h;i++)y[i-1]=arguments[i];e.fn.apply(e.context,y)}else{var A=e.length,w;for(i=0;i<A;i++)switch(e[i].once&&this.removeListener(t,e[i].fn,void 0,!0),h){case 1:e[i].fn.call(e[i].context);break;case 2:e[i].fn.call(e[i].context,n);break;case 3:e[i].fn.call(e[i].context,n,r);break;case 4:e[i].fn.call(e[i].context,n,r,v);break;default:if(!y)for(w=1,y=new Array(h-1);w<h;w++)y[w-1]=arguments[w];e[i].fn.apply(e[i].context,y)}}return!0},u.prototype.on=function(t,n,r){return x(this,t,n,r,!1)},u.prototype.once=function(t,n,r){return x(this,t,n,r,!0)},u.prototype.removeListener=function(t,n,r,v){var l=o?o+t:t;if(!this._events[l])return this;if(!n)return b(this,l),this;var c=this._events[l];if(c.fn)c.fn===n&&(!v||c.once)&&(!r||c.context===r)&&b(this,l);else{for(var d=0,e=[],h=c.length;d<h;d++)(c[d].fn!==n||v&&!c[d].once||r&&c[d].context!==r)&&e.push(c[d]);e.length?this._events[l]=e.length===1?e[0]:e:b(this,l)}return this},u.prototype.removeAllListeners=function(t){var n;return t?(n=o?o+t:t,this._events[n]&&b(this,n)):(this._events=new a,this._eventsCount=0),this},u.prototype.off=u.prototype.removeListener,u.prototype.addListener=u.prototype.on,u.prefixed=o,u.EventEmitter=u,f.exports=u})(g);var N=g.exports,O=k(N);const L=self,S="wss://livekun-webapi.anankun.icu:4433",m=new O,C=f=>{try{return JSON.parse(new TextDecoder().decode(f))}catch{return{type:"UNKNOWN",data:{}}}},T=f=>new TextEncoder().encode(JSON.stringify(f)),E=f=>{console.log("[websocket]","开始执行初始化步骤...");const p=new WebSocket(S,"web");p.binaryType="arraybuffer";const o=a=>{p.send(T(a))};return p.addEventListener("open",()=>{console.log("[websocket]","连接成功！")}),p.addEventListener("error",()=>{console.error("[websocket]","连接错误！")}),p.addEventListener("close",a=>{if(console.warn("[websocket]","连接关闭",a.code,a.reason),a.code===1002){console.error("[websocket]","远程服务器拒绝连接，不再尝试重新创建连接，请手动刷新页面！");return}console.warn("[websocket]","将于 5 秒后尝试重新创建连接..."),p.readyState!==WebSocket.CONNECTING&&p.readyState!==WebSocket.OPEN&&setTimeout(()=>E(f),5e3)}),p.addEventListener("message",a=>{const _=C(a.data);m.emit("message",_),typeof f<"u"&&f(_)}),console.log("[websocket]","初始化执行完毕！"),{send:o}},{send:P}=E();L.onconnect=f=>{const p=f.ports[0];m.on("message",o=>{p.postMessage({type:"MESSAGE",data:o})}),p.onmessage=o=>{const a=o.data;switch(a.type){case"INIT":P({type:"PLUGIN_CONNECT",data:{uuid:a.data.uuid}});break;case"PING":p.postMessage({type:"PONG"});break}}}})();
