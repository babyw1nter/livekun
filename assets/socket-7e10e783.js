import{W as a}from"./index-f726a2d9.js";const y="wss://livekun-webapi.anankun.icu:4433",N=t=>{try{return JSON.parse(new TextDecoder().decode(t))}catch{return{type:"UNKNOWN",data:{}}}},p=t=>new TextEncoder().encode(JSON.stringify(t)),w=async(t,n,d,s)=>{var i;const c=((i=a.currentRoute.value.query.uuid)==null?void 0:i.toString())||"";if(!c)return console.warn("没有 UUID 参数，不连接 socket 服务器！"),Promise.resolve(null);console.log("正在创建 WS 连接...");const e=new WebSocket(y,"web");e.binaryType="arraybuffer";const u=o=>{e.send(p(o))};return e.addEventListener("open",()=>{console.log("连接成功！"),u({type:"PLUGIN_CONNECT",data:{pluginName:t,uuid:c}})}),e.addEventListener("error",()=>{console.error("连接错误！")}),e.addEventListener("close",o=>{if(console.warn("连接关闭",o.code,o.reason),o.code===1002){console.error("远程服务器拒绝连接，不再尝试重新创建连接，请手动刷新页面！");return}console.warn("将于 5 秒后尝试重新创建连接..."),e.readyState!==WebSocket.CONNECTING&&e.readyState!==WebSocket.OPEN&&window.setTimeout(()=>w(t,n,d,s),5e3)}),e.addEventListener("message",o=>{const r=N(o.data);console.info("接收消息",r),typeof s<"u"&&s(o,e,r),typeof n<"u"&&(r==null?void 0:r.type)==="PLUGIN_ACTION"&&n(r.data.action),typeof d<"u"&&(r==null?void 0:r.type)==="PLUGIN_MESSAGE"&&d(r.data)}),Promise.resolve(e)};export{w as u};
